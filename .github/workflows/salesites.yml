name: Multi-Website-Deployment

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Enter branch name to deploy"
        required: true
        default: "main"

jobs:
  Build-and-Deploy:
    runs-on: ubuntu-latest

    steps:

      # ==================================
      # Checkout Selected Branch
      # ==================================
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}

      # ==================================
      # Setup NodeJS
      # ==================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ==================================
      # Install Dependencies
      # ==================================
      - name: Install Dependencies
        run: npm install

      # ==================================
      # Build Static Website
      # ==================================
      - name: Build Website
        run: npm run build

      # ==================================
      # Prepare Target Folder on Server
      # ==================================
      - name: Prepare Deployment Directory
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            BRANCH="${{ github.event.inputs.branch }}"
            TARGET_DIR="/var/www/${BRANCH}"
            TEMP_DIR="/home/ubuntu/tmp_deploy"

            echo "Deploying branch: $BRANCH"
            echo "Target directory: $TARGET_DIR"

            # Create temp folder for upload
            if [ ! -d "$TEMP_DIR" ]; then
              mkdir -p "$TEMP_DIR"
              echo "Temp upload folder created: $TEMP_DIR"
            else
              rm -rf ${TEMP_DIR:?}/*
              echo "Temp folder cleaned: $TEMP_DIR"
            fi

            # Create target folder if not exists
            if [ ! -d "$TARGET_DIR" ]; then
              sudo mkdir -p "$TARGET_DIR"
              echo "Target folder created: $TARGET_DIR"
            fi

            # Clean old deployment safely
            sudo rm -rf ${TARGET_DIR:?}/*

      # ==================================
      # Upload Build Files to Temp Folder
      # ==================================
      - name: Upload Website Files to Temp
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: "dist/*"
          target: "/home/ubuntu/tmp_deploy"

      # ==================================
      # Move Files from Temp to /var/www
      # ==================================
      - name: Move Files to /var/www
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            BRANCH="${{ github.event.inputs.branch }}"
            TARGET_DIR="/var/www/${BRANCH}"
            TEMP_DIR="/home/ubuntu/tmp_deploy"

            # Move files with sudo
            sudo mv ${TEMP_DIR}/* $TARGET_DIR/
            sudo chown -R www-data:www-data "$TARGET_DIR"
            sudo chmod -R 755 "$TARGET_DIR"
            sudo rm -rf "$TEMP_DIR"

      # ==================================
      # Reload Nginx
      # ==================================
      - name: Reload Nginx
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            sudo systemctl reload nginx
            echo "Nginx reloaded"
